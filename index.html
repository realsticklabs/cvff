<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video to Images and Back</title>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      font-size: 24px;
    }
    #output {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Convert Video to Frames and Back</h1>
  
  <!-- File input -->
  <input type="file" id="videoInput" accept="video/*"><br><br>

  <!-- Button to start processing -->
  <button id="processButton">Process Video</button>

  <!-- Output Section -->
  <div id="output"></div>

  <!-- Script -->
  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    // Helper function to log to the output div
    function logMessage(message) {
      const outputDiv = document.getElementById('output');
      const messageElement = document.createElement('p');
      messageElement.textContent = message;
      outputDiv.appendChild(messageElement);
    }

    document.getElementById('processButton').addEventListener('click', async () => {
      const videoInput = document.getElementById('videoInput').files[0];
      
      // Check if a video is uploaded
      if (!videoInput) {
        alert('Please upload a video file.');
        return;
      }

      logMessage('Video file loaded. Processing...');

      try {
        if (!ffmpeg.isLoaded()) {
          await ffmpeg.load();
          logMessage('FFmpeg loaded successfully.');
        }

        const videoFileName = 'input.mp4';  // Input video format
        await ffmpeg.FS('writeFile', videoFileName, await fetchFile(videoInput));

        logMessage('Extracting frames from video...');
        
        // Extract frames from video (1 frame per second)
        await ffmpeg.run('-i', videoFileName, '-vf', 'fps=1', 'frame_%04d.png');
        
        logMessage('Frames extracted successfully!');

        // Save metadata to JSON format
        const metadata = {
          originalFileName: videoInput.name,
          extractedFrames: [],
        };
        
        const numFrames = 5; // Modify based on actual frames extracted
        for (let i = 1; i <= numFrames; i++) {
          metadata.extractedFrames.push(`frame_${String(i).padStart(4, '0')}.png`);
        }
        
        const jsonData = JSON.stringify(metadata, null, 2);
        logMessage('Metadata generated.');

        // Generate .cvff file (custom format)
        const cvffData = `Comic Video File Format v1.0\n${jsonData}`;
        
        // Download metadata and cvff files
        downloadFile('metadata.json', jsonData);
        downloadFile('video.cvff', cvffData);

        logMessage('Metadata and .cvff files ready for download.');

        // Recreate video from extracted frames (1 FPS)
        logMessage('Reassembling video from frames...');
        await ffmpeg.run('-framerate', '1', '-i', 'frame_%04d.png', 'output.mp4');
        const outputVideo = ffmpeg.FS('readFile', 'output.mp4');

        // Create a video element and display it
        const videoBlob = new Blob([outputVideo.buffer], { type: 'video/mp4' });
        const videoUrl = URL.createObjectURL(videoBlob);
        const videoElement = document.createElement('video');
        videoElement.src = videoUrl;
        videoElement.controls = true;
        document.getElementById('output').appendChild(videoElement);
        
        logMessage('Video reassembled successfully!');
        logMessage('Process complete!');
      } catch (error) {
        logMessage(`An error occurred: ${error.message}`);
        console.error('FFmpeg error:', error);
      }
    });

    // Helper function to download files
    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }
  </script>
</body>
</html>
